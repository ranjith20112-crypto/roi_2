/*function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  var data = JSON.parse(e.postData.contents);
  
  sheet.appendRow([
    data.firstName,
    data.lastName,
    data.email,
    data.phone,
    data.company,
    data.companySize,
    data.country,
    new Date()
  ]);
  
  return ContentService
    .createTextOutput(JSON.stringify({ "result": "success" }))
    .setMimeType(ContentService.MimeType.JSON);
}*/
/*
function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // Parse the JSON data
  var data = JSON.parse(e.postData.contents);
  
  // Append row with all data including ROI results
  sheet.appendRow([
    data.timestamp,
    data.firstName,
    data.lastName,
    data.email,
    data.phone,
    data.company,
    data.companySize,
    data.country,
    data.currency,
    data.annualHires,
    data.costPerHire,
    data.badHireRate,
    data.screeningCost,
    data.reductionRate,
    data.currentBadHires,
    data.badHiresPrevented,
    data.currentBadHireCost,
    data.costAvoided,
    data.screeningInvestment,
    data.timeSaved,
    data.timeValue,
    data.totalSavings,
    data.netSavings,
    data.roiPercentage
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({result: "success"}))
    .setMimeType(ContentService.MimeType.JSON);
}*/

/*
function doPost(e) {
  try {
    // Parse JSON data
    var data = JSON.parse(e.postData.contents);
    
    // Open spreadsheet - use getActiveSpreadsheet() if bound, or openById()
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Leads");
    
    // Create sheet if doesn't exist
    if (!sheet) {
      sheet = ss.insertSheet("Leads");
      
      // Create all headers (24 columns total)
      var headers = [
        "Timestamp",
        "First Name", 
        "Last Name", 
        "Email", 
        "Phone", 
        "Company", 
        "Company Size", 
        "Country",
        "Currency",
        "Annual Hires",
        "Cost Per Hire",
        "Bad Hire Rate %",
        "Screening Cost",
        "Reduction Rate %",
        "Current Bad Hires",
        "Bad Hires Prevented",
        "Current Bad Hire Cost",
        "Cost Avoided",
        "Screening Investment",
        "Time Saved (hrs)",
        "Time Value",
        "Total Savings",
        "Net Savings",
        "ROI %"
      ];
      
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");
      sheet.getRange(1, 1, 1, headers.length).setBackground("#1ac2c1");
      sheet.getRange(1, 1, 1, headers.length).setFontColor("white");
    }
    
    // Prepare row data in exact order matching headers
    var rowData = [
      data.timestamp || new Date(),
      data.firstName || "",
      data.lastName || "",
      data.email || "",
      data.phone || "",
      data.company || "",
      data.companySize || "",
      data.country || "",
      data.currency || "",
      parseInt(data.annualHires) || 0,
      parseInt(data.costPerHire) || 0,
      parseInt(data.badHireRate) || 0,
      parseInt(data.screeningCost) || 0,
      parseInt(data.reductionRate) || 0,
      parseInt(data.currentBadHires) || 0,
      parseInt(data.badHiresPrevented) || 0,
      parseInt(data.currentBadHireCost) || 0,
      parseInt(data.costAvoided) || 0,
      parseInt(data.screeningInvestment) || 0,
      parseInt(data.timeSaved) || 0,
      parseInt(data.timeValue) || 0,
      parseInt(data.totalSavings) || 0,
      parseInt(data.netSavings) || 0,
      parseInt(data.roiPercentage) || 0
    ];
    
    // Append row
    sheet.appendRow(rowData);
    
    // Auto-resize columns for better readability
    sheet.autoResizeColumns(1, 24);
    
    // Return success
    return ContentService.createTextOutput(JSON.stringify({
      "result": "success",
      "message": "Lead and ROI data saved successfully",
      "rowCount": rowData.length
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // Log error for debugging
    console.error("Error in doPost:", error);
    
    return ContentService.createTextOutput(JSON.stringify({
      "result": "error",
      "message": error.toString(),
      "stack": error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// For testing - allows GET requests
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    "status": "active",
    "message": "ROI Calculator API is running",
    "version": "2.0",
    "fields": 24
  })).setMimeType(ContentService.MimeType.JSON);
}*/

/*function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Leads");
    
    // Create sheet with headers if doesn't exist
    if (!sheet) {
      sheet = ss.insertSheet("Leads");
      var headers = [
        "Timestamp", "First Name", "Last Name", "Email", "Phone", "Company", 
        "Company Size", "Country", "Currency", "Annual Hires", "Cost Per Hire", 
        "Bad Hire Rate %", "Screening Cost", "Reduction Rate %", "Current Bad Hires",
        "Bad Hires Prevented", "Current Bad Hire Cost", "Cost Avoided", 
        "Screening Investment", "Time Saved (hrs)", "Time Value", "Total Savings",
        "Net Savings", "ROI %", "PDF Downloaded"
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");
    }
    
    // Prepare row (25 columns)
    var row = [
      data.timestamp || new Date(),
      data.firstName, data.lastName, data.email, data.phone, 
      data.company, data.companySize, data.country, data.currency,
      data.annualHires, data.costPerHire, data.badHireRate, 
      data.screeningCost, data.reductionRate, data.currentBadHires,
      data.badHiresPrevented, data.currentBadHireCost, data.costAvoided,
      data.screeningInvestment, data.timeSaved, data.timeValue,
      data.totalSavings, data.netSavings, data.roiPercentage,
      data.pdfDownloaded || false
    ];
    
    sheet.appendRow(row);
    
    return ContentService.createTextOutput(JSON.stringify({
      "result": "success"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      "result": "error", "message": error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}*/
/*
function doPost(e) {
  try {
    // Parse JSON data
    var data = JSON.parse(e.postData.contents);
    
    // Open spreadsheet
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName("Leads");
    
    // Create sheet with headers if doesn't exist
    if (!sheet) {
      sheet = ss.insertSheet("Leads");
      
      // All 25 headers
      var headers = [
        "Timestamp", "First Name", "Last Name", "Email", "Phone", "Company", 
        "Company Size", "Country", "Currency", "Annual Hires", "Cost Per Hire", 
        "Bad Hire Rate %", "Screening Cost", "Reduction Rate %", "Current Bad Hires",
        "Bad Hires Prevented", "Current Bad Hire Cost", "Cost Avoided", 
        "Screening Investment", "Time Saved (hrs)", "Time Value", "Total Savings",
        "Net Savings", "ROI %", "PDF Downloaded"
      ];
      
      var headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setValues([headers]);
      headerRange.setFontWeight("bold");
      headerRange.setBackground("#1ac2c1");
      headerRange.setFontColor("white");
    }
    
    // Prepare row data - FORCE ALL TO NUMBERS/STRINGS
    var row = [
      new Date(data.timestamp || Date.now()),
      String(data.firstName || ""),
      String(data.lastName || ""),
      String(data.email || ""),
      String(data.phone || ""),
      String(data.company || ""),
      String(data.companySize || ""),
      String(data.country || ""),
      String(data.currency || "INR"),
      Number(data.annualHires) || 0,
      Number(data.costPerHire) || 0,
      Number(data.badHireRate) || 0,
      Number(data.screeningCost) || 0,
      Number(data.reductionRate) || 0,
      Number(data.currentBadHires) || 0,
      Number(data.badHiresPrevented) || 0,
      Number(data.currentBadHireCost) || 0,
      Number(data.costAvoided) || 0,
      Number(data.screeningInvestment) || 0,
      Number(data.timeSaved) || 0,
      Number(data.timeValue) || 0,
      Number(data.totalSavings) || 0,
      Number(data.netSavings) || 0,
      Number(data.roiPercentage) || 0,
      data.pdfDownloaded ? "Yes" : "No"
    ];
    
    // Append row
    sheet.appendRow(row);
    
    // Auto-resize columns
    sheet.autoResizeColumns(1, 25);
    
    return ContentService.createTextOutput(JSON.stringify({
      "result": "success",
      "message": "Data saved successfully"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      "result": "error",
      "message": error.toString(),
      "stack": error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Test function
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    "status": "active",
    "message": "ROI Calculator API is running",
    "version": "3.0"
  })).setMimeType(ContentService.MimeType.JSON);
}*/
/*function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // Add headers if first row
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'Timestamp', 'Form Type', 'First Name', 'Last Name', 'Email', 'Phone', 
      'Company', 'Company Size', 'Country', 'Currency', 'Annual Hires', 
      'Cost Per Hire', 'Bad Hire Rate', 'Screening Cost', 'Reduction Rate',
      'Total Savings', 'ROI Percentage', 'Bad Hires Prevented'
    ]);
  }
  
  // Append data row
  sheet.appendRow([
    data.timestamp,
    data.formType || 'unknown',
    data.firstName || '',
    data.lastName || '',
    data.email || '',
    data.phone || '',
    data.company || '',
    data.companySize || '',
    data.country || '',
    data.currency || '',
    data.annualHires || '',
    data.costPerHire || '',
    data.badHireRate || '',
    data.screeningCost || '',
    data.reductionRate || '',
    data.totalSavings || '',
    data.roiPercentage || '',
    data.badHiresPrevented || ''
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({result: 'success'}))
    .setMimeType(ContentService.MimeType.JSON);
}*/

/*function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    const email = data.email;
    const rows = sheet.getDataRange().getValues();
    let rowIndex = -1;
    
    // Find existing row by email (only if PDF not already downloaded)
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][3] === email) { // Column D = Email
        rowIndex = i + 1;
        break;
      }
    }
    
    if (rowIndex > 0 && data.pdfDownloaded) {
      // Update existing row for PDF download
      sheet.getRange(rowIndex, 25).setValue("YES"); // Column Y
      sheet.getRange(rowIndex, 26).setValue(new Date()); // Column Z
      return ContentService.createTextOutput(JSON.stringify({result: 'updated'}))
        .setMimeType(ContentService.MimeType.JSON);
    } else if (rowIndex === -1) {
      // Append new row for fresh submission
      sheet.appendRow([
        new Date(),                    // A: Timestamp
        data.firstName || "",          // B: First Name
        data.lastName || "",           // C: Last Name
        data.email || "",              // D: Email
        data.phone || "",              // E: Phone
        data.company || "",            // F: Company
        data.companySize || "",        // G: Company Size
        data.country || "",            // H: Country
        data.currency || "",           // I: Currency
        data.annualHires || 0,         // J: Annual Hires
        data.costPerHire || 0,         // K: Cost Per Hire
        data.badHireRate || 0,         // L: Bad Hire Rate %
        data.screeningCost || 0,       // M: Screening Cost
        data.reductionRate || 0,       // N: Reduction Rate %
        data.currentBadHires || 0,     // O: Current Bad Hires
        data.badHiresPrevented || 0,   // P: Bad Hires Prevented
        data.currentBadHireCost || 0,  // Q: Current Bad Hire Cost
        data.costAvoided || 0,         // R: Cost Avoided
        data.screeningInvestment || 0, // S: Screening Investment
        data.timeSaved || 0,           // T: Time Saved (hrs)
        data.timeValue || 0,           // U: Time Value
        data.totalSavings || 0,        // V: Total Savings
        data.netSavings || 0,          // W: Net Savings
        data.roiPercentage || 0,       // X: ROI %
        data.pdfDownloaded ? "YES" : "NO", // Y: PDF Downloaded
        data.pdfDownloaded ? new Date() : "" // Z: Download Timestamp
      ]);
      
      return ContentService.createTextOutput(JSON.stringify({result: 'success'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({result: 'error', message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}*/
// Add this to your Apps Script (separate function)

/*function doPost(e) {
    try {
        var data = JSON.parse(e.postData.contents);
        
        // Open your Google Sheet (replace with your Sheet ID)
        var sheet = SpreadsheetApp.openById('1TSuez12IAiV17NkMAYc1jsMP3SvWSCeaz3a19BETKvw').getActiveSheet();
        
        // If it's a PDF download, you might want to append to a specific sheet or add a flag
        if (data.action === 'PDF_DOWNLOAD') {
            // Add to a "PDF Downloads" sheet or mark as downloaded
            var row = [
                new Date(),           // Timestamp
                data.email,           // Email
                data.company,         // Company
                data.firstName,       // First Name
                data.lastName,        // Last Name
                data.phone,           // Phone
                data.country,         // Country
                data.currency,        // Currency
                data.annualHires,     // Annual Hires
                data.costPerHire,     // Cost Per Hire
                data.badHireRate,     // Bad Hire Rate
                data.screeningCost,   // Screening Cost
                data.reductionRate,   // Reduction Rate
                data.totalSavings,    // Total Savings
                data.roiPercentage,   // ROI %
                data.pdfDownloaded,   // PDF Downloaded (true/false)
                data.downloadTimestamp // Download Time
            ];
            
            sheet.appendRow(row);
            
            return ContentService.createTextOutput(JSON.stringify({
                'result': 'success',
                'message': 'PDF download recorded'
            })).setMimeType(ContentService.MimeType.JSON);
        } else {
            // Regular form submission
            var row = [
                new Date(),
                data.email,
                data.company,
                data.firstName,
                data.lastName,
                data.phone,
                data.country,
                data.currency,
                data.annualHires,
                data.costPerHire,
                data.badHireRate,
                data.screeningCost,
                data.reductionRate,
                data.totalSavings,
                data.roiPercentage,
                false, // PDF not downloaded yet
                ''
            ];
            
            sheet.appendRow(row);
            
            return ContentService.createTextOutput(JSON.stringify({
                'result': 'success'
            })).setMimeType(ContentService.MimeType.JSON);
        }
        
    } catch (error) {
        return ContentService.createTextOutput(JSON.stringify({
            'result': 'error',
            'message': error.toString()
        })).setMimeType(ContentService.MimeType.JSON);
    }
}*/
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var action = data.action || 'lead';
    
    // YOUR GOOGLE SHEET ID - REPLACE THIS
    var sheetId = '1TSuez12IAiV17NkMAYc1jsMP3SvWSCeaz3a19BETKvw';
    var sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
    
    // ========== HANDLE LEAD FORM (User details only) ==========
    if (action === 'lead') {
      
      // Create headers if first row
      if (sheet.getLastRow() === 0) {
        var headers = [
          'Timestamp', 'First Name', 'Last Name', 'Email', 'Phone', 'Company', 
          'Company Size', 'Country', 'Currency',
          'Annual Hires', 'Cost Per Hire', 'Bad Hire Rate %', 'Screening Cost', 'Reduction Rate %',
          'Current Bad Hires', 'Bad Hires Prevented', 'Current Bad Hire Cost', 
          'Cost Avoided', 'Screening Investment', 'Time Saved (hrs)', 'Time Value', 
          'Total Savings', 'Net Savings', 'ROI %'
        ];
        sheet.appendRow(headers);
        sheet.getRange(1, 1, 1, headers.length)
          .setFontWeight('bold')
          .setBackground('#1ac2c1')
          .setFontColor('white');
      }
      
      // Add new lead row - USER DETAILS ONLY (ROI columns empty)
      sheet.appendRow([
        new Date(),                    // A: Timestamp
        data.firstName,                // B: First Name
        data.lastName,                 // C: Last Name
        data.email,                    // D: Email
        data.phone,                    // E: Phone
        data.company,                  // F: Company
        data.companySize,              // G: Company Size
        data.country,                  // H: Country
        data.currency || '',           // I: Currency
        '',                            // J: Annual Hires (empty)
        '',                            // K: Cost Per Hire (empty)
        '',                            // L: Bad Hire Rate % (empty)
        '',                            // M: Screening Cost (empty)
        '',                            // N: Reduction Rate % (empty)
        '',                            // O: Current Bad Hires (empty)
        '',                            // P: Bad Hires Prevented (empty)
        '',                            // Q: Current Bad Hire Cost (empty)
        '',                            // R: Cost Avoided (empty)
        '',                            // S: Screening Investment (empty)
        '',                            // T: Time Saved (empty)
        '',                            // U: Time Value (empty)
        '',                            // V: Total Savings (empty)
        '',                            // W: Net Savings (empty)
        ''                             // X: ROI % (empty)
      ]);
      
      return ContentService.createTextOutput(JSON.stringify({
        'result': 'success',
        'message': 'Lead saved'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // ========== HANDLE PDF DOWNLOAD (Send ROI results) ==========
    if (action === 'pdfDownload') {
      
      var email = data.email;
      var allData = sheet.getDataRange().getValues();
      var targetRow = -1;
      
      // Find most recent row with this email (search from bottom)
      for (var i = allData.length - 1; i >= 1; i--) {
        if (allData[i][3] == email) { // Column D = Email (index 3)
          targetRow = i + 1; // +1 because Sheets is 1-indexed
          break;
        }
      }
      
      if (targetRow === -1) {
        return ContentService.createTextOutput(JSON.stringify({
          'result': 'error',
          'message': 'Email not found: ' + email
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      // Update existing row with ROI data (columns J to X)
      sheet.getRange(targetRow, 10).setValue(data.annualHires);        // J
      sheet.getRange(targetRow, 11).setValue(data.costPerHire);        // K
      sheet.getRange(targetRow, 12).setValue(data.badHireRate);        // L
      sheet.getRange(targetRow, 13).setValue(data.screeningCost);      // M
      sheet.getRange(targetRow, 14).setValue(data.reductionRate);      // N
      sheet.getRange(targetRow, 15).setValue(data.currentBadHires);    // O
      sheet.getRange(targetRow, 16).setValue(data.badHiresPrevented);  // P
      sheet.getRange(targetRow, 17).setValue(data.currentBadHireCost);  // Q
      sheet.getRange(targetRow, 18).setValue(data.costAvoided);        // R
      sheet.getRange(targetRow, 19).setValue(data.screeningInvestment); // S
      sheet.getRange(targetRow, 20).setValue(data.timeSaved);          // T
      sheet.getRange(targetRow, 21).setValue(data.timeValue);          // U
      sheet.getRange(targetRow, 22).setValue(data.totalSavings);         // V
      sheet.getRange(targetRow, 23).setValue(data.netSavings);          // W
      sheet.getRange(targetRow, 24).setValue(data.roiPercentage);       // X
      
      return ContentService.createTextOutput(JSON.stringify({
        'result': 'success',
        'message': 'ROI data added to existing row'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'error',
      'message': 'Unknown action: ' + action
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'error',
      'message': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    'status': 'active',
    'message': 'API is working'
  })).setMimeType(ContentService.MimeType.JSON);
}
// Add this temporarily to test your connection
function testConnection() {
    fetch(scriptURL + '?test=1', {
        method: 'GET',
        mode: 'no-cors'
    })
    .then(() => console.log('Connection test sent'))
    .catch(err => console.error('Connection test failed:', err));
}

// Run this in console: testConnection()
